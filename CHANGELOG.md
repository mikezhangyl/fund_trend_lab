# 更新日志 | Changelog

## 2026-01-14 - 使用复权净值计算涨幅

### 问题描述
基金涨幅计算不准确。例如基金 217002，天天基金网显示近一年涨幅为 21.78%，但系统显示只有 8.77%。

### 原因分析
之前使用**累计净值**计算涨幅，但累计净值的定义和复权净值不同：
- **单位净值**：当前每份基金的价值
- **累计净值**：单位净值 + 历史分红总额（不考虑再投资）
- **复权净值**：假设分红再投资后的真实价值（这是我们需要的）

### 修复方案
修改 `fetch_fund_history()` 方法，计算**前复权净值**：

1. 获取单位净值走势
2. 获取分红送配详情
3. 计算复权因子：每次分红后，分红金额 ÷ 当日净值 = 额外获得的份额比例
4. 复权净值 = 单位净值 × 复权因子

### 验证结果
| 基金 217002 | 日期 | 复权净值 |
|---|---|---|
| 起始 | 2025-01-14 | 6.5727 |
| 最新 | 2026-01-14 | 8.0041 |
| **涨幅** | | **21.78%** ✅ |

---

## 2026-01-14 - 修复图表 Tooltip 和 Y 轴显示问题

### 问题1：Tooltip 在屏幕边界被遮挡
- 添加 `confine: true` 限制 tooltip 在图表容器内
- 添加智能 `position` 函数：左边空间不足时显示在右边

### 问题2：Y 轴刻度显示精度过长
- Y 轴 formatter 从字符串模板改为函数：`(value) => \`${value.toFixed(2)}%\``

### 问题3：Y 轴范围受指数影响
- Y 轴范围只基于**目标基金数据**计算，不包含参考指数

---

## 2026-01-14 - 添加基金删除功能

### 功能描述
用户可以删除已添加的基金，**同时从数据库删除该基金的所有数据**。

### 实现细节

#### 后端
- `database.py` - 添加 `delete_instrument(code)` 函数
- `main.py` - 添加 `DELETE /api/instruments/{code}` 端点

#### 前端
- `api.ts` - 添加 `deleteInstrument(code)` API 函数
- `useAppState.tsx` - 更新 `removeInstrument` 调用后端删除 API  
- `FundRow.tsx` - 在基金行右侧添加删除按钮（带确认对话框）

---

## 2026-01-14 - 修复基金净值获取问题

### 问题描述
基金的历史净值无法正确获取。

### 原因分析
原代码使用 `fund_open_fund_daily_em()` 获取基金历史数据，但此 API 只返回**所有基金的当日净值**，而非单个基金的历史净值走势。

### 修复方案
使用 `fund_open_fund_info_em(symbol, indicator)` 获取单个基金的历史净值走势。

### 相关文档
- AKShare 公募基金数据文档: https://akshare.akfamily.xyz/data/fund/fund_public.html

